# 数据分表方案

## 1. 项目介绍
&ensp;&ensp;&ensp;&ensp;当前星云主网账户、交易、事件等数据存储在rocksdb数据库中，读取和写入的方式是通过Trie数据结构。举一个例子来说明，比如在接收到新块时，对于交易数据的验证和写入，需要找到上一个block的交易Trie根，然后往Trie中按照一定的方式插入数据，插入的过程需要涉及到对路径上各个节点的数据的读取和处理，在数据读取的过程中，由于历史数据在一个数据表中过于庞大，并且rocksdb存储的数据很有可能会被整理到更深的level，导致数据读取会花费掉很长的时间，不利于系统的整体性能。所以我们提出了分表项目，将新产生的数据写入新的数据表，争取达到减少数据读取时间的目的，从而提高系统的整体性能。


## 2. 项目目标
&ensp;&ensp;&ensp;&ensp;对于最新的数据分出一个新的数据表来进行存储，如上文所描述的项目产生原因，我们需要通过分表来达到减少数据读取时间的目的，从而提高系统的整体性能。预计通过分表可以提升15%的整体性能，预计提升15%的TPS。

## 3. 项目实施
**3.1** 对于events和tx数据，可以比较明确的是，绝大部分的操作是对最新数据的读写，而accounts数据则不一定，比如冷钱包的存在，很有可能的情况是往该钱包存入一笔nas之后过了好几年才进行取出的操作，这样的情况导致了accounts数据的读取没有时间的局部性，且不可预测。所以我们目前只对event是和tx数据进行分表，每隔100万个block分出一个新的Trie树根，且分出一个新的数据表存储event和tx数据。（对于隔多少个block分表，这个数据还需要进一步的大量测试，初步定为100万block，并可以通过配置文件进行配置）

**3.2** 存储每一个Trie树根和顺序关系，方便进行回溯查询

**3.3** 对于新的tx和events数据插入到新的Trie树，对于外界的查询请求，先查询新的Trie树，如果查询不到数据，再查询前一个Trie树

**3.4** 对于存储的get操作，先get最新的数据分表，如果查询不到再去get上一个分表，对于put操作，一律put到最新的分表，对于del操作，先执行get操作确定是在哪个分表中，再在指定的分表中执行del操作

**3.5** 为了保证系统能平稳，和数据快速查询的目的，数据存储有一定的冗余，比如到了100万高度的时候，后面的20万高度产生的交易和events数据会同时存储到旧表和新表，对于查询的请求仍然是从旧表中查询数据，当到了120万高度的时候，将Trie的树根切换到新的树根，从新表中查询数据。初步定为20万这个值，具体的更优的值需要进一步测试，同时可以写入配置文件进行配置